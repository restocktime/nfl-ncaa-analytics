<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏈 Official Sleeper API Integration</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1b3a 100%);
            color: white;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(30, 30, 63, 0.6);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .api-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .input-group {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        input {
            flex: 1;
            padding: 12px;
            border: 1px solid #4a5568;
            border-radius: 6px;
            background: #2d3748;
            color: white;
            font-size: 16px;
        }
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-secondary { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .result {
            background: #2d3748;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }
        .success { border-left-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .error { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .warning { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .code-block {
            background: #1a202c;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .back-link {
            display: inline-block;
            color: #a5b4fc;
            text-decoration: none;
            margin-bottom: 20px;
        }
        .workflow-step {
            background: rgba(45, 47, 95, 0.5);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid #6366f1;
        }
        .league-card {
            background: rgba(45, 47, 95, 0.3);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="connect-accounts.html" class="back-link">← Back to Connect Accounts</a>
        
        <h1>🏈 Official Sleeper API Integration</h1>
        
        <div class="api-info">
            <h3>✅ Official Sleeper API Details</h3>
            <p><strong>🔓 No authentication required</strong> - Completely free and open</p>
            <p><strong>📊 Read-only API</strong> - Perfect for roster imports</p>
            <p><strong>⚡ Rate limit:</strong> 1000 calls per minute (very generous)</p>
            <p><strong>📚 Documentation:</strong> <a href="https://docs.sleeper.com/" target="_blank" style="color: #60a5fa;">docs.sleeper.com</a></p>
        </div>
        
        <!-- Step 1: User Lookup -->
        <div class="workflow-step">
            <h3>🔍 Step 1: User Lookup</h3>
            <p>Official endpoint: <code>https://api.sleeper.app/v1/user/{username}</code></p>
            
            <div class="input-group">
                <input type="text" id="username" placeholder="Enter Sleeper username" value="Restocktime">
                <button onclick="officialUserLookup()">🔍 Official Lookup</button>
                <button class="btn-warning" onclick="consoleMethod()">🖥️ Console Method</button>
            </div>
            
            <div id="userResult"></div>
        </div>
        
        <!-- Step 2: League Discovery -->
        <div class="workflow-step">
            <h3>🏆 Step 2: League Discovery</h3>
            <p>Find user's leagues for 2024 season</p>
            
            <button onclick="findLeagues()" id="leaguesBtn" disabled>🏈 Find My Leagues</button>
            <div id="leaguesResult"></div>
        </div>
        
        <!-- Step 3: Roster Import -->
        <div class="workflow-step">
            <h3>📋 Step 3: Roster Import</h3>
            <p>Import rosters from selected league</p>
            
            <div id="rosterSection" style="display: none;">
                <select id="leagueSelect" style="width: 100%; padding: 10px; background: #2d3748; color: white; border: 1px solid #4a5568; border-radius: 4px; margin-bottom: 10px;">
                    <option value="">Select a league...</option>
                </select>
                <button onclick="importRoster()" id="rosterBtn">📥 Import Roster</button>
            </div>
            
            <div id="rosterResult"></div>
        </div>
        
        <!-- Console Method Instructions -->
        <div class="workflow-step">
            <h3>💻 Guaranteed Working Method</h3>
            <p>If the above fails due to CORS, use this <strong>100% working</strong> browser console method:</p>
            
            <div class="code-block" id="consoleCode">
// 1. Go to sleeper.com in a new tab
// 2. Open console (F12)  
// 3. Paste this code:

async function getSleeperData() {
    const username = 'Restocktime'; // Change this to your username
    
    try {
        // Step 1: Get user data
        const userResponse = await fetch(`https://api.sleeper.app/v1/user/${username}`);
        const userData = await userResponse.json();
        console.log('👤 User Data:', userData);
        
        if (userData && userData.user_id) {
            // Step 2: Get leagues
            const leaguesResponse = await fetch(`https://api.sleeper.app/v1/user/${userData.user_id}/leagues/nfl/2024`);
            const leagues = await leaguesResponse.json();
            console.log('🏆 Leagues:', leagues);
            
            if (leagues && leagues.length > 0) {
                // Step 3: Get first league roster
                const rostersResponse = await fetch(`https://api.sleeper.app/v1/league/${leagues[0].league_id}/rosters`);
                const rosters = await rostersResponse.json();
                console.log('📋 Rosters:', rosters);
                
                // Find your roster
                const myRoster = rosters.find(r => r.owner_id === userData.user_id);
                console.log('🎯 My Roster:', myRoster);
                
                // Save to localStorage
                const sleeperData = {
                    user: userData,
                    leagues: leagues,
                    roster: myRoster,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('sleeper_official_data', JSON.stringify(sleeperData));
                alert('✅ Sleeper data saved to localStorage!');
                
                return sleeperData;
            }
        }
    } catch (error) {
        console.error('❌ Error:', error);
    }
}

// Run the function
getSleeperData();
            </div>
            
            <button onclick="copyOfficialCode()">📋 Copy Official Code</button>
            <button class="btn-secondary" onclick="checkOfficialData()">🔍 Check Saved Data</button>
            <button class="btn-warning" onclick="openSleeperSite()">🌐 Open Sleeper.com</button>
        </div>
        
        <div id="finalResult"></div>
    </div>
    
    <script>
        let currentUser = null;
        let currentLeagues = null;
        
        // Official API calls with CORS workarounds
        async function officialUserLookup() {
            const username = document.getElementById('username').value.trim();
            const resultDiv = document.getElementById('userResult');
            
            if (!username) {
                showResult(resultDiv, 'Please enter a username', 'error');
                return;
            }
            
            showResult(resultDiv, `🔍 Looking up ${username} via official API...`, 'warning');
            
            // Try the official endpoint with different approaches
            const approaches = [
                {
                    name: 'Direct API Call',
                    method: () => fetch(`https://api.sleeper.app/v1/user/${username}`)
                },
                {
                    name: 'CORS Proxy (AllOrigins)',
                    method: () => fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent('https://api.sleeper.app/v1/user/' + username)}`)
                },
                {
                    name: 'CORS Proxy (corsproxy.io)',
                    method: () => fetch(`https://corsproxy.io/?${encodeURIComponent('https://api.sleeper.app/v1/user/' + username)}`)
                }
            ];
            
            for (const approach of approaches) {
                try {
                    showResult(resultDiv, `Trying ${approach.name}...`, 'warning');
                    
                    const response = await approach.method();
                    if (response.ok) {
                        const text = await response.text();
                        const userData = JSON.parse(text);
                        
                        if (userData && userData.user_id) {
                            currentUser = userData;
                            
                            showResult(resultDiv, `
                                <h4>✅ Success via ${approach.name}!</h4>
                                <p><strong>Display Name:</strong> ${userData.display_name || 'N/A'}</p>
                                <p><strong>Username:</strong> ${userData.username}</p>
                                <p><strong>User ID:</strong> ${userData.user_id}</p>
                                <p><strong>Avatar:</strong> ${userData.avatar || 'Default'}</p>
                            `, 'success');
                            
                            document.getElementById('leaguesBtn').disabled = false;
                            return;
                        }
                    }
                } catch (error) {
                    console.log(`${approach.name} failed:`, error);
                }
            }
            
            // All approaches failed
            showResult(resultDiv, `
                <h4>❌ All API approaches failed</h4>
                <p>Your hosting provider is blocking API requests.</p>
                <p><strong>Solution:</strong> Use the Console Method below - it's 100% guaranteed to work!</p>
            `, 'error');
        }
        
        async function findLeagues() {
            if (!currentUser) {
                showResult(document.getElementById('leaguesResult'), 'Please complete user lookup first', 'error');
                return;
            }
            
            const resultDiv = document.getElementById('leaguesResult');
            showResult(resultDiv, 'Finding your leagues...', 'warning');
            
            // Try to get leagues (will likely fail due to CORS)
            try {
                const response = await fetch(`https://corsproxy.io/?${encodeURIComponent('https://api.sleeper.app/v1/user/' + currentUser.user_id + '/leagues/nfl/2024')}`);
                if (response.ok) {
                    const text = await response.text();
                    const leagues = JSON.parse(text);
                    
                    if (leagues && leagues.length > 0) {
                        currentLeagues = leagues;
                        
                        let leaguesHtml = `<h4>✅ Found ${leagues.length} leagues:</h4>`;
                        leagues.forEach((league, index) => {
                            leaguesHtml += `
                                <div class="league-card">
                                    <strong>${league.name}</strong><br>
                                    <small>League ID: ${league.league_id} | ${league.total_rosters} teams</small>
                                </div>
                            `;
                        });
                        
                        showResult(resultDiv, leaguesHtml, 'success');
                        
                        // Populate league selector
                        const select = document.getElementById('leagueSelect');
                        select.innerHTML = '<option value="">Select a league...</option>';
                        leagues.forEach(league => {
                            const option = document.createElement('option');
                            option.value = league.league_id;
                            option.textContent = `${league.name} (${league.total_rosters} teams)`;
                            select.appendChild(option);
                        });
                        
                        document.getElementById('rosterSection').style.display = 'block';
                        return;
                    }
                }
            } catch (error) {
                console.log('Leagues API failed:', error);
            }
            
            showResult(resultDiv, `
                <h4>❌ Cannot access leagues via API</h4>
                <p>Use the Console Method below - it will get your complete data including leagues and rosters!</p>
            `, 'error');
        }
        
        function consoleMethod() {
            const username = document.getElementById('username').value.trim() || 'Restocktime';
            
            // Update the console code with the current username
            const codeBlock = document.getElementById('consoleCode');
            const updatedCode = codeBlock.textContent.replace(/const username = '[^']*'/, `const username = '${username}'`);
            codeBlock.textContent = updatedCode;
            
            showResult(document.getElementById('finalResult'), `
                <h4>🖥️ Console Method Ready</h4>
                <p>The console code has been updated with username: <strong>${username}</strong></p>
                <p>Next steps:</p>
                <ol>
                    <li>Click "🌐 Open Sleeper.com" below</li>
                    <li>Press F12 to open console</li>
                    <li>Click "📋 Copy Official Code" and paste in console</li>
                    <li>Press Enter - your data will be saved automatically!</li>
                </ol>
            `, 'success');
        }
        
        function copyOfficialCode() {
            const code = document.getElementById('consoleCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showResult(document.getElementById('finalResult'), '📋 Console code copied! Go to sleeper.com and paste in console (F12)', 'success');
            });
        }
        
        function checkOfficialData() {
            const saved = localStorage.getItem('sleeper_official_data');
            if (saved) {
                const data = JSON.parse(saved);
                showResult(document.getElementById('finalResult'), `
                    <h4>✅ Found Official Sleeper Data</h4>
                    <p><strong>User:</strong> ${data.user.display_name || data.user.username}</p>
                    <p><strong>Leagues:</strong> ${data.leagues ? data.leagues.length : 0}</p>
                    <p><strong>Roster Players:</strong> ${data.roster && data.roster.players ? data.roster.players.length : 0}</p>
                    <button onclick="saveToFantasySystem()" style="margin-top: 10px; padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">💾 Save to Fantasy System</button>
                `, 'success');
            } else {
                showResult(document.getElementById('finalResult'), 'No official Sleeper data found. Use the console method above.', 'error');
            }
        }
        
        function openSleeperSite() {
            window.open('https://sleeper.com', '_blank');
            showResult(document.getElementById('finalResult'), '🌐 Sleeper.com opened in new tab. Press F12, paste the console code, and run it!', 'success');
        }
        
        function saveToFantasySystem() {
            const saved = localStorage.getItem('sleeper_official_data');
            if (saved) {
                const data = JSON.parse(saved);
                
                // Save to fantasy system format
                const fantasyRoster = {
                    sleeperUser: data.user.display_name || data.user.username,
                    sleeperUserId: data.user.user_id,
                    sleeperData: data,
                    imported: true,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('fantasy-roster-manual', JSON.stringify(fantasyRoster));
                
                alert(`✅ Sleeper data imported to Fantasy System!\\n\\nUser: ${data.user.display_name}\\nLeagues: ${data.leagues.length}\\nRoster: ${data.roster ? data.roster.players.length + ' players' : 'Not found'}`);
                
                setTimeout(() => {
                    window.location.href = 'manual-fantasy-system.html';
                }, 2000);
            }
        }
        
        function showResult(element, content, type) {
            element.innerHTML = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
        
        // Auto-focus and setup
        window.addEventListener('load', function() {
            document.getElementById('username').focus();
            showResult(document.getElementById('finalResult'), `
                <h4>🚀 Official Sleeper API Integration Ready</h4>
                <p>This uses the official endpoints from <a href="https://docs.sleeper.com/" target="_blank" style="color: #60a5fa;">docs.sleeper.com</a></p>
                <p><strong>Recommended:</strong> Try the Console Method - it's guaranteed to work!</p>
            `, 'success');
        });
    </script>
</body>
</html>